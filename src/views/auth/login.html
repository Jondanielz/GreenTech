<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Purple Admin</title>
    <!-- plugins:css -->
    <link
      rel="stylesheet"
      href="../../assets/vendors/mdi/css/materialdesignicons.min.css"
    />
    <link
      rel="stylesheet"
      href="../../assets/vendors/ti-icons/css/themify-icons.css"
    />
    <link
      rel="stylesheet"
      href="../../assets/vendors/css/vendor.bundle.base.css"
    />
    <link
      rel="stylesheet"
      href="../../assets/vendors/font-awesome/css/font-awesome.min.css"
    />
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="../../assets/css/style.css" />
    <!-- End layout styles -->
    <link rel="shortcut icon" href="../../assets/images/favicon.png" />
  </head>
  <body>
    <div class="container-scroller">
      <div class="container-fluid page-body-wrapper full-page-wrapper">
        <div class="content-wrapper d-flex align-items-center auth">
          <div class="row flex-grow">
            <div class="col-lg-4 mx-auto">
              <div class="auth-form-light text-left p-5">
                <div class="brand-logo">
                  <img
                    src="../../assets/images/logo.svg"
                    alt="Logo Purple Admin"
                  />
                </div>
                <h4>Hello! let's get started</h4>
                <h6 class="font-weight-light">Sign in to continue.</h6>

                <!-- Mensaje de error -->
                <div
                  id="errorMessage"
                  class="alert alert-danger"
                  style="display: none"
                  role="alert"
                ></div>

                <form class="pt-3" id="loginForm">
                  <div class="form-group">
                    <input
                      type="text"
                      class="form-control form-control-lg"
                      id="username"
                      name="username"
                      placeholder="Usuario"
                      required
                      autocomplete="username"
                    />
                  </div>
                  <div class="form-group">
                    <input
                      type="password"
                      class="form-control form-control-lg"
                      id="password"
                      name="password"
                      placeholder="Contrase√±a"
                      required
                      autocomplete="current-password"
                    />
                  </div>
                  <div class="mt-2 d-grid gap-2 pt-2">
                    <button
                      type="submit"
                      class="btn btn-block btn-gradient-primary btn-lg font-weight-medium auth-form-btn"
                      id="loginButton"
                    >
                      SIGN IN
                    </button>
                  </div>
                  <div
                    class="my-2 d-flex justify-content-between align-items-center"
                  >
                    <div class="form-check">
                      <label class="form-check-label text-muted">
                        <input
                          type="checkbox"
                          class="form-check-input"
                          id="rememberMe"
                        />
                        Keep me signed in
                      </label>
                    </div>
                    <a href="#" class="auth-link text-black"
                      >Forgot password?</a
                    >
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <!-- content-wrapper ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->
    <!-- plugins:js -->
    <script src="../../assets/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="../../assets/js/off-canvas.js"></script>
    <script src="../../assets/js/misc.js"></script>
    <script src="../../assets/js/settings.js"></script>
    <script src="../../assets/js/todolist.js"></script>
    <script src="../../assets/js/jquery.cookie.js"></script>
    <!-- endinject -->

    <!-- Script de autenticaci√≥n -->
    <script type="module">
      import AuthService from "../../services/auth.js";

      // Redirigir si ya est√° autenticado
      if (AuthService.isAuthenticated()) {
        window.location.href = "/";
      }

      // Manejar env√≠o del formulario
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value;
          const errorDiv = document.getElementById("errorMessage");
          const loginButton = document.getElementById("loginButton");

          // Validaci√≥n b√°sica
          if (!username || !password) {
            errorDiv.textContent = "Por favor, ingresa usuario y contrase√±a";
            errorDiv.style.display = "block";
            return;
          }

          // Limpiar errores previos
          errorDiv.style.display = "none";
          errorDiv.textContent = "";

          // Deshabilitar bot√≥n y mostrar loading
          loginButton.disabled = true;
          loginButton.innerHTML =
            '<i class="mdi mdi-loading mdi-spin"></i> Ingresando...';

          try {
            console.log("üîê Intentando login con:", username);

            const result = await AuthService.login(username, password);

            if (result.success) {
              console.log("‚úÖ Login exitoso!", result.user);

              // Mostrar mensaje de √©xito
              errorDiv.className = "alert alert-success";
              errorDiv.textContent = "¬°Bienvenido! Redirigiendo...";
              errorDiv.style.display = "block";

              // Guardar "Remember me" si est√° marcado
              const rememberMe = document.getElementById("rememberMe").checked;
              if (rememberMe) {
                localStorage.setItem("rememberMe", "true");
              }

              // Redirigir al dashboard despu√©s de 500ms
              setTimeout(() => {
                window.location.href = "/";
              }, 500);
            } else {
              // Login fall√≥
              console.error("‚ùå Login fall√≥:", result.message);
              errorDiv.className = "alert alert-danger";
              errorDiv.textContent =
                result.message || "Usuario o contrase√±a incorrectos";
              errorDiv.style.display = "block";

              // Re-habilitar bot√≥n
              loginButton.disabled = false;
              loginButton.textContent = "SIGN IN";
            }
          } catch (error) {
            console.error("üí• Error en login:", error);
            errorDiv.className = "alert alert-danger";
            errorDiv.textContent =
              "Error de conexi√≥n. Verifica que Apache y MySQL est√©n corriendo.";
            errorDiv.style.display = "block";

            // Re-habilitar bot√≥n
            loginButton.disabled = false;
            loginButton.textContent = "SIGN IN";
          }
        });

      // Limpiar mensaje de error al escribir
      document.getElementById("username").addEventListener("input", () => {
        document.getElementById("errorMessage").style.display = "none";
      });

      document.getElementById("password").addEventListener("input", () => {
        document.getElementById("errorMessage").style.display = "none";
      });

      console.log("üöÄ Login page loaded - Ready to authenticate!");
    </script>
  </body>
</html>
