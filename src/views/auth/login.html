<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Iniciar Sesi√≥n - GreenTech</title>
    <!-- plugins:css -->
    <link
      rel="stylesheet"
      href="/src/assets/vendors/mdi/css/materialdesignicons.min.css"
    />
    <link
      rel="stylesheet"
      href="/src/assets/vendors/ti-icons/css/themify-icons.css"
    />
    <link
      rel="stylesheet"
      href="/src/assets/vendors/css/vendor.bundle.base.css"
    />
    <link
      rel="stylesheet"
      href="/src/assets/vendors/font-awesome/css/font-awesome.min.css"
    />
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="/src/assets/css/style.css" />
    <!-- End layout styles -->
    <link rel="shortcut icon" href="/src/assets/images/favicon.png" />
  </head>
  <body>
    <div class="container-scroller">
      <div class="container-fluid page-body-wrapper full-page-wrapper">
        <div
          class="content-wrapper d-flex align-items-center auth"
          style="
            min-height: 100vh;
            background: linear-gradient(135deg, #57c785 0%, #62a984 100%);
          "
        >
          <div class="row flex-grow">
            <div class="col-lg-4 mx-auto">
              <div
                class="auth-form-light text-left p-5 shadow"
                style="border-radius: 16px; background: #ffffff"
              >
                <div class="brand-logo mb-4">
                  <img
                    src="/src/assets/images/logo.svg"
                    alt="Logo GreenTech"
                  />
                </div>

                <!-- Avatar centrado -->
                <div class="text-center mb-4">
                  <div
                    class="user-avatar-circle mx-auto mb-3"
                    style="
                      width: 80px;
                      height: 80px;
                      background: linear-gradient(
                        135deg,
                        #57c785 0%,
                        #62a984 100%
                      );
                      border-radius: 50%;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      box-shadow: 0 4px 12px rgba(87, 199, 133, 0.3);
                    "
                  >
                    <i
                      class="mdi mdi-account text-white"
                      style="font-size: 2.5rem"
                    ></i>
                  </div>
                  <h4 class="mb-1" style="color: #2c3e50">¬°Bienvenido!</h4>
                  <h6 class="font-weight-light mb-4" style="color: #6c757d">
                    Inicia sesi√≥n para continuar
                  </h6>
                </div>

                <!-- Mensaje de error -->
                <div
                  id="errorMessage"
                  class="alert alert-danger"
                  style="display: none"
                  role="alert"
                ></div>

                <form class="pt-2" id="loginForm">
                  <div class="form-group">
                    <div class="input-group">
                      <span class="input-group-text bg-light border-end-0">
                        <i class="mdi mdi-account text-muted"></i>
                      </span>
                      <input
                        type="text"
                        class="form-control form-control-lg border-start-0"
                        id="username"
                        name="username"
                        placeholder="Correo o usuario"
                        required
                        autocomplete="username"
                      />
                    </div>
                  </div>
                  <div class="form-group">
                    <div class="input-group">
                      <span class="input-group-text bg-light border-end-0">
                        <i class="mdi mdi-lock text-muted"></i>
                      </span>
                      <input
                        type="password"
                        class="form-control form-control-lg border-start-0 border-end-0"
                        id="password"
                        name="password"
                        placeholder="Contrase√±a"
                        required
                        autocomplete="current-password"
                      />
                      <button
                        type="button"
                        class="input-group-text bg-light border-start-0"
                        id="togglePassword"
                        style="cursor: pointer"
                      >
                        <i class="mdi mdi-eye text-muted" id="passwordIcon"></i>
                      </button>
                    </div>
                  </div>
                  <div class="mt-2 d-grid gap-2 pt-2">
                    <button
                      type="submit"
                      class="btn btn-block btn-success btn-lg font-weight-medium auth-form-btn d-flex align-items-center justify-content-center"
                      id="loginButton"
                      style="border-radius: 12px"
                    >
                      <i class="mdi mdi-login me-2"></i>Ingresar
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <!-- content-wrapper ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->
    <!-- plugins:js -->
    <script src="/src/assets/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="/src/assets/js/off-canvas.js"></script>
    <script src="/src/assets/js/misc.js"></script>
    <script src="/src/assets/js/settings.js"></script>
    <script src="/src/assets/js/todolist.js"></script>
    <script src="/src/assets/js/jquery.cookie.js"></script>
    <!-- endinject -->

    <!-- Script de autenticaci√≥n -->
    <script type="module">
      import AuthService from "/src/services/auth.js";

      // Redirigir si ya est√° autenticado
      if (AuthService.isAuthenticated()) {
        window.location.href = "/";
      }

      // Manejar env√≠o del formulario
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const username = document.getElementById("username").value.trim();
          const password = document.getElementById("password").value;
          const errorDiv = document.getElementById("errorMessage");
          const loginButton = document.getElementById("loginButton");

          // Validaci√≥n b√°sica
          if (!username || !password) {
            errorDiv.textContent = "Por favor, ingresa usuario y contrase√±a";
            errorDiv.style.display = "block";
            return;
          }

          // Limpiar errores previos
          errorDiv.style.display = "none";
          errorDiv.textContent = "";

          // Deshabilitar bot√≥n y mostrar loading
          loginButton.disabled = true;
          loginButton.innerHTML =
            '<i class="mdi mdi-loading mdi-spin"></i> Ingresando...';

          try {
            console.log("üîê Intentando login con:", username);

            const result = await AuthService.login(username, password);

            if (result.success) {
              console.log("‚úÖ Login exitoso!", result.user);

              // Mostrar mensaje de √©xito
              errorDiv.className = "alert alert-success";
              errorDiv.textContent = "¬°Bienvenido! Redirigiendo...";
              errorDiv.style.display = "block";

              // Remember me removido

              // Redirigir al dashboard despu√©s de 500ms
              setTimeout(() => {
                window.location.href = "/";
              }, 500);
            } else {
              // Login fall√≥
              console.error("‚ùå Login fall√≥:", result.message);
              errorDiv.className = "alert alert-danger";
              errorDiv.textContent =
                result.message || "Usuario o contrase√±a incorrectos";
              errorDiv.style.display = "block";

              // Re-habilitar bot√≥n
              loginButton.disabled = false;
              loginButton.textContent = "Ingresar";
            }
          } catch (error) {
            console.error("üí• Error en login:", error);
            errorDiv.className = "alert alert-danger";
            errorDiv.textContent =
              "Error de conexi√≥n. Verifica que Apache y MySQL est√©n corriendo.";
            errorDiv.style.display = "block";

            // Re-habilitar bot√≥n
            loginButton.disabled = false;
            loginButton.textContent = "Ingresar";
          }
        });

      // Limpiar mensaje de error al escribir
      document.getElementById("username").addEventListener("input", () => {
        document.getElementById("errorMessage").style.display = "none";
      });

      document.getElementById("password").addEventListener("input", () => {
        document.getElementById("errorMessage").style.display = "none";
      });

      // Toggle password visibility
      document
        .getElementById("togglePassword")
        .addEventListener("click", function () {
          const passwordInput = document.getElementById("password");
          const passwordIcon = document.getElementById("passwordIcon");

          if (passwordInput.type === "password") {
            passwordInput.type = "text";
            passwordIcon.className = "mdi mdi-eye-off text-muted";
          } else {
            passwordInput.type = "password";
            passwordIcon.className = "mdi mdi-eye text-muted";
          }
        });

      console.log("üöÄ Login page loaded - Ready to authenticate!");
    </script>
  </body>
</html>
